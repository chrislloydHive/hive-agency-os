# Stabilization Scope: 2025-12-12

**Purpose:** Define merge boundaries to prevent scope creep.

---

## In Scope (Ship This)

### Trust & Governance Fixes
- [x] AI-assist route converted to proposal flow (no direct writes)
- [x] `computeProposalForAI()` returns `requiresUserApproval: true`
- [x] Source priority enforcement in `lib/contextGraph/sourcePriority.ts`
- [x] Governance index updates in `lib/contextGraph/governance/index.ts`

### Doctrine Injection
- [x] Centralized HIVE_DOCTRINE in `lib/os/globalContext/hiveDoctrine.ts`
- [x] `formatForPrompt()` injects doctrine by default
- [x] Strategy context uses full doctrine mode

### Context Graph Improvements
- [x] `lib/contextGraph/forAi.ts` enhancements
- [x] Context Workspace client updates
- [x] REUSE REQUIRED headers on new context components

### QBR & Reporting
- [x] QBR route and data updates
- [x] QBRReportClient improvements
- [x] QBR component barrel exports (`components/qbr/index.ts`)
- [x] `lib/os/reports/qbrData.ts` additions

### Strategy Workspace
- [x] StrategyWorkspaceClient expansion
- [x] Strategy page updates
- [x] Work item status display

### Core Types
- [x] `lib/types/work.ts` updates
- [x] `lib/types/workMvp.ts` additions
- [x] `lib/os/work.ts` changes

### Infrastructure
- [x] Airtable tables config
- [x] Package.json dependency updates
- [x] Feature flags configuration (`lib/config/featureFlags.ts`)

---

## Feature Flags (Gating Experimental Features)

The following features are gated by environment variables and **disabled by default**:

| Feature | Flag | Env Variable | Default |
|---------|------|--------------|---------|
| Labs System | `LABS_ENABLED` | `NEXT_PUBLIC_FEATURE_LABS` | `false` |
| Daily Briefing | `DAILY_BRIEFING_ENABLED` | `NEXT_PUBLIC_FEATURE_DAILY_BRIEFING` | `false` |
| Automation | `AUTOMATION_ENABLED` | `NEXT_PUBLIC_FEATURE_AUTOMATION` | `false` |

**Always ON (core features):**
- Context Workspace
- Strategy Workspace
- QBR Reports

To enable a gated feature, set the environment variable to `true`:
```bash
NEXT_PUBLIC_FEATURE_LABS=true
```

---

## Out of Scope (Do NOT Ship Yet)

### Labs System (GATED: `NEXT_PUBLIC_FEATURE_LABS=true`)
- `lib/os/labs/` (audience, creativeStrategy, execution, media, mediaScenarios)
- `app/api/os/companies/[companyId]/labs/*` routes
- `app/c/[companyId]/labs/*` UI pages
- **Reason:** Not wired to existing Context Graph; creates parallel data model
- **Status:** Feature-flagged OFF by default; returns 403 if accessed

### Automation System (GATED: `NEXT_PUBLIC_FEATURE_AUTOMATION=true`)
- `lib/os/automation/` (rules, triggers, runAutomation)
- `components/automation/`
- `app/api/os/companies/[companyId]/automation/` route
- **Reason:** Untested trigger conditions; could cause unintended writes
- **Status:** Feature-flagged OFF by default; component returns null, API returns 403

### Daily Briefing (GATED: `NEXT_PUBLIC_FEATURE_DAILY_BRIEFING=true`)
- `lib/os/briefing/daily/`
- `components/os/DailyBriefPanel.tsx`
- `app/api/os/companies/[companyId]/brief/` route
- **Reason:** Depends on Labs data that isn't shipping
- **Status:** Feature-flagged OFF by default; component returns null, API returns 403

### Write Contract System
- `lib/os/writeContract/` (apply, diff, locks, proposal, revision)
- **Reason:** Needs review for trust invariant compliance

### Context V2/V3 Types
- `lib/types/contextV2.ts`
- `lib/types/contextV3.ts`
- `lib/os/contextV2/`
- **Reason:** Parallel type system; must map to existing Context Graph domains

### Strategy V2
- `lib/os/strategyV2/`
- `lib/types/strategyV2.ts`
- `app/api/os/strategy/v2/` route
- **Reason:** Separate from current strategy flow

### Competition System
- `lib/os/competition/`
- **Reason:** Needs validation against existing competition analysis

---

## Merge Blockers Checklist

Before merging, verify:

- [ ] `npm run build` passes with no errors
- [ ] `npm run lint` passes
- [ ] `npx tsc` type-checks cleanly
- [ ] No untracked Labs/Automation/Briefing files are staged
- [ ] Trust regression tests pass (`tests/context/trustRegression.test.ts`)
- [ ] AI routes return proposals, not direct writes
- [ ] Context components use existing section patterns (per REUSE REQUIRED)
- [ ] No new `contextV2` or `strategyV2` imports in shipped code
- [ ] Doctrine injection confirmed single-source (`hiveDoctrine.ts`)
- [ ] Manual smoke test: AI suggestions require user approval

---

## File Classification

### SHIP (19 modified files)
```
app/api/os/companies/[companyId]/qbr/route.ts
app/api/os/context/ai-assist/route.ts
app/c/[companyId]/context/ContextWorkspaceClient.tsx
app/c/[companyId]/page.tsx
app/c/[companyId]/reports/qbr/QBRReportClient.tsx
app/c/[companyId]/strategy/StrategyWorkspaceClient.tsx
app/c/[companyId]/strategy/page.tsx
app/c/[companyId]/work/WorkItemCardWithStatus.tsx
components/os/CompanyOverviewPage.tsx
components/qbr/index.ts
lib/airtable/tables.ts
lib/contextGraph/forAi.ts
lib/contextGraph/governance/index.ts
lib/contextGraph/sourcePriority.ts
lib/os/reports/qbrData.ts
lib/os/work.ts
lib/types/work.ts
lib/types/workMvp.ts
package.json
```

### HOLD (untracked directories)
```
app/api/os/companies/[companyId]/automation/
app/api/os/companies/[companyId]/brief/
app/api/os/companies/[companyId]/labs/
app/api/os/companies/[companyId]/strategy/generate-work/
app/api/os/companies/[companyId]/strategy/ideas/
app/api/os/context/v2/
app/api/os/strategy/v2/
app/c/[companyId]/labs/
app/c/[companyId]/qbr/strategy/
components/automation/
lib/os/automation/
lib/os/briefing/
lib/os/competition/
lib/os/contextV2/
lib/os/globalContext/
lib/os/labs/
lib/os/qbr/
lib/os/strategy/
lib/os/strategyV2/
lib/os/work/
lib/os/writeContract/
lib/types/contextV2.ts
lib/types/contextV3.ts
lib/types/strategyV2.ts
```

---

## Notes

- New `components/context/` files have REUSE REQUIRED headers but should be reviewed before shipping
- `lib/os/globalContext/hiveDoctrine.ts` is critical infrastructure but ships as untrackedâ€”verify it's included if doctrine injection is shipping
- QBR components (`components/qbr/QBR*.tsx`) may depend on held code; verify imports
