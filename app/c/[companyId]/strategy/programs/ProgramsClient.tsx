'use client';

// app/c/[companyId]/strategy/programs/ProgramsClient.tsx
// Programs Workspace Client Component
//
// AI-FIRST: Programs are generated by AI, reviewed/tweaked by humans
// - Generate Website Program (AI) button starts generation
// - AI draft shown as proposal before saving
// - User reviews, tweaks, then saves
// - Refresh with AI to improve existing programs

import { useState, useCallback, useEffect } from 'react';
import Link from 'next/link';
import {
  Loader2,
  Save,
  CheckCircle,
  AlertCircle,
  ChevronDown,
  ChevronRight,
  Target,
  Layers,
  ListChecks,
  Trash2,
  Globe,
  Briefcase,
  FileText,
  Sparkles,
  RefreshCw,
  AlertTriangle,
  HelpCircle,
  Link as LinkIcon,
  Ban,
  Plus,
  ArrowRight,
  ClipboardList,
  Clock,
} from 'lucide-react';
import type {
  ProgramRecord,
  ProgramType,
  ProgramPlan,
  WebsiteProgramPlan,
  ContentProgramPlan,
  ProgramPriority,
  ProgramPhase,
  ProgramReadinessGate,
  ProgramExclusion,
  AIProgramDraft,
  GenerateProgramResponse,
} from '@/lib/types/program';
import { useContextV4Health } from '@/hooks/useContextV4Health';
import type { V4HealthResponse } from '@/lib/types/contextV4Health';
import {
  ContextV4HealthGate,
  ContextV4HealthInlineWarning,
  ContextV4HealthReadyIndicator,
} from '@/components/context-v4/ContextV4HealthGate';

// ============================================================================
// Types
// ============================================================================

interface InputsSummary {
  context: {
    hasContext: boolean;
    businessModel: string | null;
    primaryOffering: string | null;
    primaryAudience: string | null;
    primaryObjective: string | null;
    geographicFootprint: string | null;
    websiteScore: number | null;
    hasWebsiteLab: boolean;
    // Content Lab
    contentScore: number | null;
    hasContentLab: boolean;
  };
  strategy: {
    hasStrategy: boolean;
    positioning: string | null;
    primaryObjective: string | null;
  };
}

interface FreshnessData {
  contextUpdatedAt: string | null;
  strategyUpdatedAt: string | null;
  websiteLabUpdatedAt: string | null;
  contentLabUpdatedAt: string | null;
  programUpdatedAt: string | null;
}

interface ProgramsClientProps {
  companyId: string;
  companyName: string;
  initialPrograms: ProgramRecord[];
  inputsSummary: InputsSummary;
  freshnessData: FreshnessData;
  initialProgramType?: ProgramType;
}

type ViewMode = 'empty' | 'generating' | 'proposal' | 'editor';

// Website Lab run status from API
interface LabRunStatus {
  status: 'completed' | 'running' | 'failed' | 'pending' | 'not_started';
  runId?: string;
  score?: number | null;
  summary?: string;
  completedAt?: string;
}

// ============================================================================
// Freshness Helpers
// ============================================================================

/**
 * Format a timestamp as "X days ago" or "X hours ago"
 */
function formatTimeAgo(timestamp: string | null): string | null {
  if (!timestamp) return null;

  const date = new Date(timestamp);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));

  if (diffDays > 30) {
    const diffMonths = Math.floor(diffDays / 30);
    return `${diffMonths} month${diffMonths === 1 ? '' : 's'} ago`;
  }
  if (diffDays > 0) {
    return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
  }
  if (diffHours > 0) {
    return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
  }
  return 'just now';
}

/**
 * Check if an input is stale (updated after the program)
 */
function isInputStale(inputUpdatedAt: string | null, programUpdatedAt: string | null): boolean {
  if (!inputUpdatedAt || !programUpdatedAt) return false;
  return new Date(inputUpdatedAt).getTime() > new Date(programUpdatedAt).getTime();
}

// ============================================================================
// Readiness Check
// ============================================================================

interface ReadinessIssue {
  label: string;
  description: string;
  fixLink: string;
  fixLabel: string;
}

interface ProgramReadiness {
  isReady: boolean;
  issues: ReadinessIssue[];
}

/**
 * Check if all prerequisites are met for generating a Program.
 * Returns issues that must be resolved before generation.
 *
 * Website Program requires:
 * - Context: Business Model, ICP (Primary Audience), Primary Offer, Geo
 * - At least one completed Website Lab run (from actual diagnostic runs, not context)
 *
 * Content Program requires:
 * - Context: Business Model, Primary Audience
 * - At least one completed Content Lab run (from actual diagnostic runs, not context)
 */
function checkProgramReadiness(
  inputsSummary: InputsSummary,
  companyId: string,
  programType: ProgramType,
  websiteLabStatus: LabRunStatus | null,
  contentLabStatus: LabRunStatus | null,
  loadingLabStatus: boolean
): ProgramReadiness {
  const issues: ReadinessIssue[] = [];

  // Check required Context fields
  // Website Program has stricter requirements
  const contextIssues: string[] = [];
  if (!inputsSummary.context.businessModel) contextIssues.push('Business Model');
  if (!inputsSummary.context.primaryAudience) contextIssues.push('ICP / Primary Audience');

  // Website Program requires additional fields
  if (programType === 'website') {
    if (!inputsSummary.context.primaryOffering) contextIssues.push('Primary Offer');
    if (!inputsSummary.context.geographicFootprint) contextIssues.push('Geographic Footprint');
  }

  if (contextIssues.length > 0) {
    issues.push({
      label: 'Context incomplete',
      description: `Missing: ${contextIssues.join(', ')}`,
      fixLink: `/c/${companyId}/context`,
      fixLabel: 'Complete Context',
    });
  }

  // Check domain-specific Lab completion (source of truth: actual diagnostic runs)
  // Don't show "missing" while still loading
  if (!loadingLabStatus) {
    if (programType === 'content') {
      const hasCompletedContentLab = contentLabStatus?.status === 'completed';
      if (!hasCompletedContentLab) {
        issues.push({
          label: 'No Content Lab run found',
          description: 'Run Content Analysis to assess your content state',
          fixLink: `/c/${companyId}/diagnostics/content`,
          fixLabel: 'Run Content Lab',
        });
      }
    } else {
      // Website program - check actual completed Website Lab run
      const hasCompletedWebsiteLab = websiteLabStatus?.status === 'completed';
      if (!hasCompletedWebsiteLab) {
        issues.push({
          label: 'No Website Lab run found',
          description: 'Run Website Diagnostics to generate evidence for the program',
          fixLink: `/c/${companyId}/blueprint`,
          fixLabel: 'Run Website Lab',
        });
      }
    }
  }

  return {
    isReady: issues.length === 0,
    issues,
  };
}

// ============================================================================
// Component
// ============================================================================

export function ProgramsClient({
  companyId,
  companyName,
  initialPrograms,
  inputsSummary,
  freshnessData,
  initialProgramType: propInitialProgramType,
}: ProgramsClientProps) {
  // Program type selection - use prop if provided, otherwise check existing programs
  const computedInitialProgramType: ProgramType =
    propInitialProgramType ||
    initialPrograms.find(p => p.type === 'website')?.type ||
    initialPrograms.find(p => p.type === 'content')?.type ||
    'website';
  const [selectedProgramType, setSelectedProgramType] = useState<ProgramType>(computedInitialProgramType);

  // Filter programs by selected type
  const filteredPrograms = initialPrograms.filter(p => p.type === selectedProgramType);

  // State
  const [programs, setPrograms] = useState<ProgramRecord[]>(initialPrograms);
  const [selectedProgram, setSelectedProgram] = useState<ProgramRecord | null>(
    filteredPrograms.find(p => p.status === 'active') ||
    filteredPrograms.find(p => p.status === 'draft') ||
    null
  );
  const [editedPlan, setEditedPlan] = useState<ProgramPlan | null>(
    selectedProgram?.plan || null
  );

  // AI Generation state
  const [viewMode, setViewMode] = useState<ViewMode>(selectedProgram ? 'editor' : 'empty');
  const [aiDraft, setAiDraft] = useState<AIProgramDraft | null>(null);
  const [aiReasoning, setAiReasoning] = useState<string>('');
  const [aiInputsUsed, setAiInputsUsed] = useState<GenerateProgramResponse['inputsUsed'] | null>(null);

  // Refresh diff state
  const [isRefreshMode, setIsRefreshMode] = useState(false);
  const [previousPlan, setPreviousPlan] = useState<ProgramPlan | null>(null);

  // UI state
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);
  const [converting, setConverting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);
  const [convertedWorkItemCount, setConvertedWorkItemCount] = useState<number | null>(null);
  const [existingWorkItemCount, setExistingWorkItemCount] = useState<number | null>(null);
  const [checkingWorkItems, setCheckingWorkItems] = useState(false);

  // Website Lab / Content Lab status (fetched from API - source of truth)
  const [websiteLabStatus, setWebsiteLabStatus] = useState<LabRunStatus | null>(null);
  const [contentLabStatus, setContentLabStatus] = useState<LabRunStatus | null>(null);
  const [loadingLabStatus, setLoadingLabStatus] = useState(true);

  // Context V4 Health (using unified hook)
  const {
    health: v4Health,
    loading: loadingV4Health,
  } = useContextV4Health(companyId);

  // Derived state
  const hasChanges = !!(selectedProgram && editedPlan &&
    JSON.stringify(selectedProgram.plan) !== JSON.stringify(editedPlan));

  // Track if we have unsaved AI draft applied (new program not yet saved)
  const hasUnsavedDraft = !!(editedPlan && !selectedProgram);

  // Readiness check for AI generation (based on selected program type + actual lab runs)
  const programReadiness = checkProgramReadiness(
    inputsSummary,
    companyId,
    selectedProgramType,
    websiteLabStatus,
    contentLabStatus,
    loadingLabStatus
  );

  // Check if any input is stale (updated after the program)
  const labUpdatedAt = selectedProgramType === 'content'
    ? freshnessData.contentLabUpdatedAt
    : freshnessData.websiteLabUpdatedAt;
  const hasStaleInputs = selectedProgram && freshnessData.programUpdatedAt && (
    isInputStale(freshnessData.contextUpdatedAt, freshnessData.programUpdatedAt) ||
    isInputStale(freshnessData.strategyUpdatedAt, freshnessData.programUpdatedAt) ||
    isInputStale(labUpdatedAt, freshnessData.programUpdatedAt)
  );

  // Program type label for display
  const programTypeLabel = selectedProgramType === 'content' ? 'Content' : 'Website';

  // Handle program type change
  const handleProgramTypeChange = (newType: ProgramType) => {
    setSelectedProgramType(newType);
    // Find existing program of this type
    const existingProgram = programs.find(p => p.type === newType && (p.status === 'active' || p.status === 'draft'));
    setSelectedProgram(existingProgram || null);
    setEditedPlan(existingProgram?.plan || null);
    setViewMode(existingProgram ? 'editor' : 'empty');
    // Reset other state
    setAiDraft(null);
    setAiReasoning('');
    setAiInputsUsed(null);
    setIsRefreshMode(false);
    setPreviousPlan(null);
    setError(null);
    setSuccessMessage(null);
    setExistingWorkItemCount(null); // Reset work item count on program change
  };

  // ============================================================================
  // Fetch Lab Status (Source of Truth for Program Readiness)
  // ============================================================================

  useEffect(() => {
    const fetchLabStatus = async () => {
      setLoadingLabStatus(true);

      try {
        // Fetch both labs in parallel
        const [websiteRes, contentRes] = await Promise.all([
          fetch(`/api/os/diagnostics/status/websiteLab?companyId=${companyId}`),
          fetch(`/api/os/diagnostics/status/contentLab?companyId=${companyId}`),
        ]);

        if (websiteRes.ok) {
          const data = await websiteRes.json();
          setWebsiteLabStatus({
            status: data.status,
            runId: data.runId,
            score: data.score,
            summary: data.summary,
          });
        }

        if (contentRes.ok) {
          const data = await contentRes.json();
          setContentLabStatus({
            status: data.status,
            runId: data.runId,
            score: data.score,
            summary: data.summary,
          });
        }
      } catch (err) {
        console.error('[ProgramsClient] Failed to fetch lab status:', err);
      } finally {
        setLoadingLabStatus(false);
      }
    };

    fetchLabStatus();
  }, [companyId]);

  // V4 Health is fetched via useContextV4Health hook above

  // ============================================================================
  // Check for existing work items when program changes
  // ============================================================================

  useEffect(() => {
    if (!selectedProgram) {
      setExistingWorkItemCount(null);
      return;
    }

    const checkExistingWorkItems = async () => {
      setCheckingWorkItems(true);
      try {
        const response = await fetch(`/api/os/companies/${companyId}/work-items?programId=${selectedProgram.id}`);
        if (response.ok) {
          const data = await response.json();
          // Count items with source.programId matching this program
          const count = data.workItems?.filter((item: { source?: { programId?: string } }) =>
            item.source?.programId === selectedProgram.id
          ).length || 0;
          setExistingWorkItemCount(count);
        }
      } catch (err) {
        console.error('[ProgramsClient] Failed to check existing work items:', err);
        setExistingWorkItemCount(null);
      } finally {
        setCheckingWorkItems(false);
      }
    };

    checkExistingWorkItems();
  }, [selectedProgram, companyId]);

  // ============================================================================
  // AI Generation
  // ============================================================================

  const handleGenerateProgram = useCallback(async (mode: 'create' | 'refresh' = 'create') => {
    setLoading(true);
    setError(null);
    setViewMode('generating');

    // Store previous plan for refresh diff view
    if (mode === 'refresh' && selectedProgram?.plan) {
      setIsRefreshMode(true);
      setPreviousPlan(selectedProgram.plan);
    } else {
      setIsRefreshMode(false);
      setPreviousPlan(null);
    }

    try {
      const response = await fetch(`/api/os/companies/${companyId}/programs/generate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          mode,
          programType: selectedProgramType,
          existingProgramId: mode === 'refresh' ? selectedProgram?.id : undefined,
        }),
      });

      const data: GenerateProgramResponse = await response.json();

      if (!response.ok) {
        throw new Error((data as unknown as { error: string }).error || 'Failed to generate program');
      }

      setAiDraft(data.draft);
      setAiReasoning(data.reasoning);
      setAiInputsUsed(data.inputsUsed);
      setViewMode('proposal');
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to generate program');
      setViewMode(selectedProgram ? 'editor' : 'empty');
      // Reset refresh state on error
      setIsRefreshMode(false);
      setPreviousPlan(null);
    } finally {
      setLoading(false);
    }
  }, [companyId, selectedProgram, selectedProgramType]);

  const handleApplyProposal = useCallback(() => {
    if (!aiDraft) return;

    // Convert AI draft to plan format
    const plan: WebsiteProgramPlan = {
      title: aiDraft.title,
      summary: aiDraft.summary,
      objectiveFraming: aiDraft.objectiveFraming,
      currentStateSummary: aiDraft.currentStateSummary,
      priorities: aiDraft.priorities,
      sequencing: aiDraft.sequencing,
      exclusions: aiDraft.exclusions,
      readinessGates: aiDraft.readinessGates,
      assumptions: aiDraft.assumptions,
      unknowns: aiDraft.unknowns,
      dependencies: aiDraft.dependencies,
      inputsSnapshot: aiDraft.inputsSnapshot,
    };

    setEditedPlan(plan);
    setViewMode('editor');
    setIsRefreshMode(false);
    setPreviousPlan(null);
    setSuccessMessage('Draft applied - review and save when ready');
    setTimeout(() => setSuccessMessage(null), 3000);
  }, [aiDraft]);

  const handleDiscardProposal = useCallback(() => {
    setAiDraft(null);
    setAiReasoning('');
    setAiInputsUsed(null);
    setIsRefreshMode(false);
    setPreviousPlan(null);
    setViewMode(selectedProgram ? 'editor' : 'empty');
  }, [selectedProgram]);

  // ============================================================================
  // CRUD Handlers
  // ============================================================================

  const handleSave = useCallback(async () => {
    if (!editedPlan) return;

    setSaving(true);
    setError(null);

    try {
      let program = selectedProgram;

      // If no program exists, create one first
      if (!program) {
        const createResponse = await fetch(`/api/os/companies/${companyId}/programs`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: selectedProgramType, plan: editedPlan }),
        });

        const createData = await createResponse.json();

        if (!createResponse.ok) {
          throw new Error(createData.error || 'Failed to create program');
        }

        program = createData.program;
        setPrograms(prev => [createData.program, ...prev]);
        setSelectedProgram(createData.program);
      } else {
        // Update existing program
        const response = await fetch(
          `/api/os/companies/${companyId}/programs/${program.id}`,
          {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              plan: {
                title: editedPlan.title,
                summary: editedPlan.summary,
                objectiveFraming: editedPlan.objectiveFraming,
                currentStateSummary: editedPlan.currentStateSummary,
                priorities: editedPlan.priorities,
                sequencing: editedPlan.sequencing,
                exclusions: editedPlan.exclusions,
                readinessGates: editedPlan.readinessGates,
                assumptions: editedPlan.assumptions,
                unknowns: editedPlan.unknowns,
                dependencies: editedPlan.dependencies,
              },
            }),
          }
        );

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to save program');
        }

        setSelectedProgram(data.program);
        setEditedPlan(data.program.plan);
        setPrograms(prev =>
          prev.map(p => (p.id === data.program.id ? data.program : p))
        );
      }

      setSuccessMessage('Saved!');
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to save');
    } finally {
      setSaving(false);
    }
  }, [companyId, selectedProgram, editedPlan]);

  const handleActivate = useCallback(async () => {
    if (!selectedProgram) return;

    setLoading(true);
    setError(null);

    try {
      const response = await fetch(
        `/api/os/companies/${companyId}/programs/${selectedProgram.id}/activate`,
        { method: 'POST' }
      );

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to activate program');
      }

      setSelectedProgram(data.program);
      setEditedPlan(data.program.plan);
      setPrograms(prev =>
        prev.map(p => {
          if (p.id === data.program.id) return data.program;
          if (data.archived.includes(p.id)) return { ...p, status: 'archived' as const };
          return p;
        })
      );
      setSuccessMessage('Program activated!');
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to activate');
    } finally {
      setLoading(false);
    }
  }, [companyId, selectedProgram]);

  // ============================================================================
  // Convert to Work
  // ============================================================================

  const handleConvertToWork = useCallback(async () => {
    if (!selectedProgram) return;

    setConverting(true);
    setError(null);
    setConvertedWorkItemCount(null);

    try {
      const response = await fetch(
        `/api/os/companies/${companyId}/programs/${selectedProgram.id}/convert-to-work`,
        { method: 'POST' }
      );

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to convert program to work');
      }

      setConvertedWorkItemCount(data.workItemsCreated);
      setExistingWorkItemCount(data.workItemsCreated); // Update existing count
      setSuccessMessage(`Created ${data.workItemsCreated} work items!`);
      setTimeout(() => {
        setSuccessMessage(null);
      }, 5000);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to convert to work');
    } finally {
      setConverting(false);
    }
  }, [companyId, selectedProgram]);

  // ============================================================================
  // Plan Editors
  // ============================================================================

  const updatePlanField = useCallback(
    <K extends keyof WebsiteProgramPlan>(field: K, value: WebsiteProgramPlan[K]) => {
      setEditedPlan(prev => (prev ? { ...prev, [field]: value } : prev));
    },
    []
  );

  // ============================================================================
  // Render
  // ============================================================================

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100">
      {/* Header */}
      <div className="border-b border-slate-800 bg-slate-900/50">
        <div className="px-6 py-4">
          <div className="flex items-center justify-between">
            <div>
              <div className="flex items-center gap-2 text-sm text-slate-400 mb-1">
                <a href={`/c/${companyId}`} className="hover:text-slate-300">
                  {companyName}
                </a>
                <span>/</span>
                <a href={`/c/${companyId}/programs`} className="hover:text-slate-300">
                  Programs
                </a>
                <span>/</span>
                <span className="text-slate-200">{programTypeLabel}</span>
              </div>
              <div className="flex items-center gap-4">
                <h1 className="text-xl font-semibold text-white flex items-center gap-2">
                  {selectedProgramType === 'content' ? (
                    <FileText className="w-5 h-5 text-blue-400" />
                  ) : (
                    <Globe className="w-5 h-5 text-blue-400" />
                  )}
                  {programTypeLabel} Program
                </h1>
                {/* Program Type Tabs */}
                <div className="flex bg-slate-800 rounded-lg p-1">
                  <button
                    onClick={() => handleProgramTypeChange('website')}
                    className={`px-3 py-1.5 text-sm rounded-md transition-colors ${
                      selectedProgramType === 'website'
                        ? 'bg-blue-600 text-white'
                        : 'text-slate-400 hover:text-white'
                    }`}
                  >
                    <Globe className="w-4 h-4 inline mr-1.5" />
                    Website
                  </button>
                  <button
                    onClick={() => handleProgramTypeChange('content')}
                    className={`px-3 py-1.5 text-sm rounded-md transition-colors ${
                      selectedProgramType === 'content'
                        ? 'bg-blue-600 text-white'
                        : 'text-slate-400 hover:text-white'
                    }`}
                  >
                    <FileText className="w-4 h-4 inline mr-1.5" />
                    Content
                  </button>
                </div>
              </div>
            </div>

            {/* Actions */}
            <div className="flex items-center gap-3">
              {/* Unsaved changes indicator */}
              {(hasChanges || hasUnsavedDraft) && (
                <span className="flex items-center gap-1.5 text-sm text-amber-400 bg-amber-900/30 px-2 py-1 rounded">
                  <AlertCircle className="w-4 h-4" />
                  Unsaved changes
                </span>
              )}

              {successMessage && (
                <span className="flex items-center gap-1.5 text-sm text-green-400">
                  <CheckCircle className="w-4 h-4" />
                  {successMessage}
                </span>
              )}

              {error && (
                <span className="flex items-center gap-1.5 text-sm text-red-400">
                  <AlertCircle className="w-4 h-4" />
                  {error}
                </span>
              )}

              {viewMode === 'empty' && (
                <button
                  onClick={() => handleGenerateProgram('create')}
                  disabled={loading || !programReadiness.isReady}
                  title={!programReadiness.isReady ? 'Complete required inputs first' : undefined}
                  className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {loading ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    <Sparkles className="w-4 h-4" />
                  )}
                  Generate {programTypeLabel} Program (AI)
                </button>
              )}

              {viewMode === 'proposal' && (
                <>
                  <button
                    onClick={handleDiscardProposal}
                    className="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg"
                  >
                    Discard
                  </button>
                  <button
                    onClick={handleApplyProposal}
                    className="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg"
                  >
                    <CheckCircle className="w-4 h-4" />
                    Apply Draft
                  </button>
                </>
              )}

              {viewMode === 'editor' && editedPlan && (
                <>
                  {/* Refresh recommended indicator */}
                  {hasStaleInputs && (
                    <span className="flex items-center gap-1.5 px-3 py-1.5 bg-amber-900/50 text-amber-400 rounded-lg text-sm">
                      <AlertTriangle className="w-4 h-4" />
                      Refresh recommended
                    </span>
                  )}

                  <button
                    onClick={() => handleGenerateProgram('refresh')}
                    disabled={loading}
                    className={`flex items-center gap-2 px-4 py-2 text-white rounded-lg disabled:opacity-50 ${
                      hasStaleInputs
                        ? 'bg-amber-600 hover:bg-amber-500'
                        : 'bg-slate-700 hover:bg-slate-600'
                    }`}
                  >
                    {loading ? (
                      <Loader2 className="w-4 h-4 animate-spin" />
                    ) : (
                      <RefreshCw className="w-4 h-4" />
                    )}
                    Refresh with AI
                  </button>

                  <button
                    onClick={handleSave}
                    disabled={saving || (!hasChanges && !!selectedProgram)}
                    className="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg disabled:opacity-50"
                  >
                    {saving ? (
                      <Loader2 className="w-4 h-4 animate-spin" />
                    ) : (
                      <Save className="w-4 h-4" />
                    )}
                    Save
                  </button>

                  {selectedProgram?.status === 'draft' && (
                    <button
                      onClick={handleActivate}
                      disabled={loading || hasChanges}
                      title={hasChanges ? 'Save changes before activating' : undefined}
                      className="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg disabled:opacity-50"
                    >
                      {loading ? (
                        <Loader2 className="w-4 h-4 animate-spin" />
                      ) : (
                        <CheckCircle className="w-4 h-4" />
                      )}
                      Make Active
                    </button>
                  )}

                  {selectedProgram?.status === 'active' && (
                    <span className="flex items-center gap-1.5 px-3 py-1.5 bg-green-900/50 text-green-400 rounded-lg text-sm">
                      <CheckCircle className="w-4 h-4" />
                      Active
                    </span>
                  )}

                  {/* Convert to Work Section */}
                  {selectedProgram && !hasChanges && (
                    <>
                      <div className="w-px h-6 bg-slate-700" />

                      {/* Already converted - show badge and link */}
                      {existingWorkItemCount !== null && existingWorkItemCount > 0 ? (
                        <>
                          <span className="flex items-center gap-1.5 px-3 py-1.5 bg-purple-900/50 text-purple-400 rounded-lg text-sm">
                            <CheckCircle className="w-4 h-4" />
                            Converted to Work ({existingWorkItemCount} items)
                          </span>
                          <Link
                            href={`/c/${companyId}/work`}
                            className="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg"
                          >
                            View Work Items
                            <ArrowRight className="w-4 h-4" />
                          </Link>
                        </>
                      ) : (
                        /* Not yet converted - show button */
                        <button
                          onClick={handleConvertToWork}
                          disabled={converting || checkingWorkItems}
                          className="flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg disabled:opacity-50"
                        >
                          {converting ? (
                            <Loader2 className="w-4 h-4 animate-spin" />
                          ) : checkingWorkItems ? (
                            <Loader2 className="w-4 h-4 animate-spin" />
                          ) : (
                            <ClipboardList className="w-4 h-4" />
                          )}
                          Convert to Work
                        </button>
                      )}
                    </>
                  )}

                  {/* Temporary success link after conversion */}
                  {convertedWorkItemCount !== null && convertedWorkItemCount > 0 && existingWorkItemCount === 0 && (
                    <Link
                      href={`/c/${companyId}/work`}
                      className="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg"
                    >
                      View Work Items
                      <ArrowRight className="w-4 h-4" />
                    </Link>
                  )}
                </>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="flex">
        {/* Left Panel: Inputs */}
        <div className="w-80 border-r border-slate-800 bg-slate-900/30 p-4 space-y-4">
          <h2 className="text-sm font-medium text-slate-400 uppercase tracking-wide">
            Inputs (Read-only)
          </h2>

          {/* Context Summary */}
          <InputsCard
            title="Context"
            icon={<Briefcase className="w-4 h-4" />}
            status={inputsSummary.context.hasContext ? 'available' : 'missing'}
            updatedAt={freshnessData.contextUpdatedAt}
            isStale={isInputStale(freshnessData.contextUpdatedAt, freshnessData.programUpdatedAt)}
          >
            {inputsSummary.context.hasContext ? (
              <div className="space-y-2 text-sm">
                {inputsSummary.context.businessModel && (
                  <div>
                    <span className="text-slate-500">Model:</span>{' '}
                    <span className="text-slate-300">{inputsSummary.context.businessModel}</span>
                  </div>
                )}
                {inputsSummary.context.primaryOffering && (
                  <div>
                    <span className="text-slate-500">Offering:</span>{' '}
                    <span className="text-slate-300">{inputsSummary.context.primaryOffering}</span>
                  </div>
                )}
                {inputsSummary.context.primaryAudience && (
                  <div>
                    <span className="text-slate-500">Audience:</span>{' '}
                    <span className="text-slate-300">{inputsSummary.context.primaryAudience}</span>
                  </div>
                )}
                {inputsSummary.context.primaryObjective && (
                  <div>
                    <span className="text-slate-500">Objective:</span>{' '}
                    <span className="text-slate-300">{inputsSummary.context.primaryObjective}</span>
                  </div>
                )}
              </div>
            ) : (
              <p className="text-sm text-slate-500">No context available</p>
            )}
          </InputsCard>

          {/* Strategy Summary */}
          <InputsCard
            title="Strategy"
            icon={<Target className="w-4 h-4" />}
            status={inputsSummary.strategy.hasStrategy ? 'available' : 'missing'}
            updatedAt={freshnessData.strategyUpdatedAt}
            isStale={isInputStale(freshnessData.strategyUpdatedAt, freshnessData.programUpdatedAt)}
          >
            {inputsSummary.strategy.hasStrategy ? (
              <div className="space-y-2 text-sm">
                {inputsSummary.strategy.positioning && (
                  <div>
                    <span className="text-slate-500">Positioning:</span>{' '}
                    <span className="text-slate-300">{inputsSummary.strategy.positioning}</span>
                  </div>
                )}
                {inputsSummary.strategy.primaryObjective && (
                  <div>
                    <span className="text-slate-500">Objective:</span>{' '}
                    <span className="text-slate-300">{inputsSummary.strategy.primaryObjective}</span>
                  </div>
                )}
              </div>
            ) : (
              <p className="text-sm text-slate-500">No strategy defined</p>
            )}
          </InputsCard>

          {/* Lab Summary - Website or Content based on selected program type */}
          {/* Uses actual diagnostic run status (source of truth), not context flags */}
          {selectedProgramType === 'content' ? (
            <InputsCard
              title="Content Lab"
              icon={<FileText className="w-4 h-4" />}
              status={loadingLabStatus ? 'loading' : contentLabStatus?.status === 'completed' ? 'available' : 'missing'}
              updatedAt={freshnessData.contentLabUpdatedAt}
              isStale={isInputStale(freshnessData.contentLabUpdatedAt, freshnessData.programUpdatedAt)}
            >
              {loadingLabStatus ? (
                <div className="flex items-center gap-2 text-sm text-slate-500">
                  <Loader2 className="w-3 h-3 animate-spin" />
                  <span>Checking status...</span>
                </div>
              ) : contentLabStatus?.status === 'completed' ? (
                <div className="space-y-2 text-sm">
                  <div className="flex items-center gap-2 text-green-400">
                    <CheckCircle className="w-4 h-4" />
                    <span>Content Lab completed</span>
                  </div>
                  {contentLabStatus.score !== null && contentLabStatus.score !== undefined && (
                    <div className="flex items-center gap-2">
                      <span className="text-slate-500">Score:</span>
                      <span
                        className={`font-medium ${
                          contentLabStatus.score >= 70
                            ? 'text-green-400'
                            : contentLabStatus.score >= 50
                            ? 'text-yellow-400'
                            : 'text-red-400'
                        }`}
                      >
                        {contentLabStatus.score}
                      </span>
                    </div>
                  )}
                  {contentLabStatus.runId && (
                    <Link
                      href={`/c/${companyId}/diagnostics/content-lab/${contentLabStatus.runId}`}
                      className="flex items-center gap-1 text-blue-400 hover:text-blue-300 transition-colors"
                    >
                      <LinkIcon className="w-3 h-3" />
                      <span>View results</span>
                    </Link>
                  )}
                </div>
              ) : (
                <div className="space-y-2">
                  <p className="text-sm text-slate-500">No Content Lab run found</p>
                  <Link
                    href={`/c/${companyId}/blueprint`}
                    className="inline-flex items-center gap-1 text-xs text-blue-400 hover:text-blue-300"
                  >
                    Run Content Lab
                    <ArrowRight className="w-3 h-3" />
                  </Link>
                </div>
              )}
            </InputsCard>
          ) : (
            <InputsCard
              title="Website Lab"
              icon={<Globe className="w-4 h-4" />}
              status={loadingLabStatus ? 'loading' : websiteLabStatus?.status === 'completed' ? 'available' : 'missing'}
              updatedAt={freshnessData.websiteLabUpdatedAt}
              isStale={isInputStale(freshnessData.websiteLabUpdatedAt, freshnessData.programUpdatedAt)}
            >
              {loadingLabStatus ? (
                <div className="flex items-center gap-2 text-sm text-slate-500">
                  <Loader2 className="w-3 h-3 animate-spin" />
                  <span>Checking status...</span>
                </div>
              ) : websiteLabStatus?.status === 'completed' ? (
                <div className="space-y-2 text-sm">
                  <div className="flex items-center gap-2 text-green-400">
                    <CheckCircle className="w-4 h-4" />
                    <span>Website Lab completed</span>
                  </div>
                  {websiteLabStatus.score !== null && websiteLabStatus.score !== undefined && (
                    <div className="flex items-center gap-2">
                      <span className="text-slate-500">Score:</span>
                      <span
                        className={`font-medium ${
                          websiteLabStatus.score >= 70
                            ? 'text-green-400'
                            : websiteLabStatus.score >= 50
                            ? 'text-yellow-400'
                            : 'text-red-400'
                        }`}
                      >
                        {websiteLabStatus.score}
                      </span>
                    </div>
                  )}
                  {websiteLabStatus.runId && (
                    <Link
                      href={`/c/${companyId}/diagnostics/website-lab/${websiteLabStatus.runId}`}
                      className="flex items-center gap-1 text-blue-400 hover:text-blue-300 transition-colors"
                    >
                      <LinkIcon className="w-3 h-3" />
                      <span>View results</span>
                    </Link>
                  )}
                </div>
              ) : (
                <div className="space-y-2">
                  <p className="text-sm text-slate-500">No Website Lab run found</p>
                  <Link
                    href={`/c/${companyId}/blueprint`}
                    className="inline-flex items-center gap-1 text-xs text-blue-400 hover:text-blue-300"
                  >
                    Run Website Lab
                    <ArrowRight className="w-3 h-3" />
                  </Link>
                </div>
              )}
            </InputsCard>
          )}
        </div>

        {/* Main Panel */}
        <div className="flex-1 p-6 overflow-auto">
          {viewMode === 'empty' && (
            <EmptyState
              onGenerate={() => handleGenerateProgram('create')}
              loading={loading}
              readiness={programReadiness}
              programTypeLabel={programTypeLabel}
              v4Health={v4Health}
              companyId={companyId}
            />
          )}

          {viewMode === 'generating' && <GeneratingState programTypeLabel={programTypeLabel} />}

          {viewMode === 'proposal' && aiDraft && (
            <ProposalView
              draft={aiDraft}
              reasoning={aiReasoning}
              inputsUsed={aiInputsUsed}
              onApply={handleApplyProposal}
              onDiscard={handleDiscardProposal}
              isRefreshMode={isRefreshMode}
              previousPlan={previousPlan}
              programType={selectedProgramType}
            />
          )}

          {viewMode === 'editor' && editedPlan && (
            <ProgramEditor
              plan={editedPlan}
              onUpdatePlan={updatePlanField}
              status={selectedProgram?.status || 'draft'}
            />
          )}
        </div>
      </div>
    </div>
  );
}

// ============================================================================
// Sub-components
// ============================================================================

function InputsCard({
  title,
  icon,
  status,
  updatedAt,
  isStale,
  children,
}: {
  title: string;
  icon: React.ReactNode;
  status: 'available' | 'missing' | 'loading';
  updatedAt?: string | null;
  isStale?: boolean;
  children: React.ReactNode;
}) {
  const timeAgo = formatTimeAgo(updatedAt ?? null);

  return (
    <div className={`bg-slate-800/50 rounded-lg p-3 border ${isStale ? 'border-amber-600/50' : 'border-slate-700'}`}>
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2 text-sm font-medium text-slate-200">
          {icon}
          {title}
        </div>
        {status === 'loading' ? (
          <Loader2 className="w-3 h-3 animate-spin text-slate-500" />
        ) : (
          <span
            className={`w-2 h-2 rounded-full ${
              status === 'available' ? 'bg-green-500' : 'bg-slate-500'
            }`}
          />
        )}
      </div>
      {children}
      {timeAgo && (
        <div className={`mt-2 pt-2 border-t border-slate-700/50 flex items-center gap-1.5 text-xs ${isStale ? 'text-amber-400' : 'text-slate-500'}`}>
          <Clock className="w-3 h-3" />
          <span>Updated {timeAgo}</span>
          {isStale && <span className="text-amber-400">(newer than program)</span>}
        </div>
      )}
    </div>
  );
}

function EmptyState({
  onGenerate,
  loading,
  readiness,
  programTypeLabel,
  v4Health,
  companyId,
}: {
  onGenerate: () => void;
  loading: boolean;
  readiness: ProgramReadiness;
  programTypeLabel: string;
  v4Health: V4HealthResponse | null;
  companyId: string;
}) {
  const labName = programTypeLabel === 'Content' ? 'content lab' : 'website lab';

  // Show health gate only when readiness is met (so we don't double-warn)
  const showHealthGate = readiness.isReady && v4Health && v4Health.status !== 'GREEN';

  return (
    <div className="flex flex-col items-center justify-center h-96 text-center">
      <div className="p-4 bg-blue-900/30 rounded-full mb-4">
        <Sparkles className="w-12 h-12 text-blue-400" />
      </div>
      <h2 className="text-lg font-medium text-slate-300 mb-2">
        Generate Your {programTypeLabel} Program
      </h2>
      <p className="text-slate-500 mb-6 max-w-md">
        AI will analyze your context, strategy, and {labName} findings to create
        a prioritized program with sequencing and readiness gates.
      </p>

      {/* Readiness Banner - shown when prerequisites are missing */}
      {!readiness.isReady && (
        <div className="bg-amber-900/30 border border-amber-700/50 rounded-lg p-4 mb-6 max-w-lg w-full text-left">
          <div className="flex items-start gap-3">
            <AlertTriangle className="w-5 h-5 text-amber-400 mt-0.5 shrink-0" />
            <div className="flex-1">
              <h3 className="text-amber-200 font-medium mb-2">
                Complete prerequisites to generate
              </h3>
              <div className="space-y-3">
                {readiness.issues.map((issue, idx) => (
                  <div key={idx} className="flex items-start justify-between gap-3">
                    <div>
                      <p className="text-amber-300/90 text-sm font-medium">{issue.label}</p>
                      <p className="text-amber-300/70 text-xs">{issue.description}</p>
                    </div>
                    <Link
                      href={issue.fixLink}
                      className="shrink-0 flex items-center gap-1.5 px-3 py-1.5 bg-amber-600 hover:bg-amber-500 text-white text-xs font-medium rounded transition-colors"
                    >
                      {issue.fixLabel}
                      <ArrowRight className="w-3 h-3" />
                    </Link>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Context V4 Health Gate - soft warning when baseline has issues */}
      {showHealthGate && (
        <ContextV4HealthGate
          health={v4Health}
          companyId={companyId}
          onContinue={onGenerate}
          showContinueButton={true}
        />
      )}

      {/* Optional: Show subtle ready indicator when GREEN */}
      {readiness.isReady && v4Health?.status === 'GREEN' && (
        <ContextV4HealthReadyIndicator health={v4Health} />
      )}

      {/* Generate Button - only show when health gate is not displayed (or GREEN) */}
      {(!showHealthGate) && (
        <>
          <button
            onClick={onGenerate}
            disabled={loading || !readiness.isReady}
            title={!readiness.isReady ? 'Complete prerequisites first' : undefined}
            className="flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {loading ? (
              <Loader2 className="w-4 h-4 animate-spin" />
            ) : (
              <Sparkles className="w-4 h-4" />
            )}
            Generate {programTypeLabel} Program (AI)
          </button>

          {/* Inline warning under button if health is not GREEN but gate isn't shown */}
          {v4Health && v4Health.status !== 'GREEN' && !readiness.isReady && (
            <ContextV4HealthInlineWarning health={v4Health} />
          )}

          <p className="text-xs text-slate-600 mt-4">
            You&apos;ll review and approve before anything is saved
          </p>
        </>
      )}
    </div>
  );
}

function GeneratingState({ programTypeLabel }: { programTypeLabel: string }) {
  const labName = programTypeLabel === 'Content' ? 'content' : 'website';
  return (
    <div className="flex flex-col items-center justify-center h-96 text-center">
      <Loader2 className="w-12 h-12 text-blue-400 animate-spin mb-4" />
      <h2 className="text-lg font-medium text-slate-300 mb-2">
        Generating {programTypeLabel} Program...
      </h2>
      <p className="text-slate-500 max-w-md">
        AI is analyzing your context, strategy, and {labName} state to create
        a tailored program.
      </p>
    </div>
  );
}

function ProposalView({
  draft,
  reasoning,
  inputsUsed,
  onApply,
  onDiscard,
  isRefreshMode,
  previousPlan,
  programType,
}: {
  draft: AIProgramDraft;
  reasoning: string;
  inputsUsed: GenerateProgramResponse['inputsUsed'] | null;
  onApply: () => void;
  onDiscard: () => void;
  isRefreshMode: boolean;
  previousPlan: ProgramPlan | null;
  programType: ProgramType;
}) {
  // Check if any inputs were missing based on program type
  const hasRequiredLab = programType === 'content' ? inputsUsed?.hasContentLab : inputsUsed?.hasWebsiteLab;
  const labName = programType === 'content' ? 'Content Lab' : 'Website Lab';
  const missingInputs = inputsUsed && (!inputsUsed.hasContext || !inputsUsed.hasStrategy || !hasRequiredLab);

  // If in refresh mode with previous plan, show diff view
  if (isRefreshMode && previousPlan) {
    return (
      <RefreshDiffView
        previousPlan={previousPlan}
        draft={draft}
        reasoning={reasoning}
        inputsUsed={inputsUsed}
        onApply={onApply}
        onDiscard={onDiscard}
        programType={programType}
      />
    );
  }

  return (
    <div className="max-w-4xl space-y-6">
      {/* Missing inputs warning */}
      {missingInputs && (
        <div className="bg-amber-900/30 border border-amber-700/50 rounded-lg p-4">
          <div className="flex items-start gap-3">
            <AlertTriangle className="w-5 h-5 text-amber-400 mt-0.5" />
            <div>
              <h3 className="text-amber-200 font-medium mb-1">
                Some inputs were missing
              </h3>
              <p className="text-amber-300/80 text-sm">
                The proposal includes assumptions to fill gaps. Review carefully:
                {!inputsUsed?.hasContext && ' No context data available.'}
                {!inputsUsed?.hasStrategy && ' No strategy defined.'}
                {!hasRequiredLab && ` No ${labName.toLowerCase()} assessment.`}
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Proposal Header */}
      <div className="bg-blue-900/30 border border-blue-700/50 rounded-lg p-4">
        <div className="flex items-start gap-3">
          <Sparkles className="w-5 h-5 text-blue-400 mt-0.5" />
          <div className="flex-1">
            <h2 className="text-lg font-medium text-blue-200 mb-1">
              AI-Generated Draft
            </h2>
            <p className="text-blue-300/80 text-sm mb-3">
              Review this program draft. You can apply it and make edits before saving.
            </p>
            {inputsUsed && (
              <div className="flex items-center gap-4 text-xs text-blue-400/70">
                <span>Inputs used:</span>
                <span className={inputsUsed.hasContext ? 'text-green-400' : 'text-slate-500'}>
                  Context {inputsUsed.hasContext ? '' : ''}
                </span>
                <span className={inputsUsed.hasStrategy ? 'text-green-400' : 'text-slate-500'}>
                  Strategy {inputsUsed.hasStrategy ? '' : ''}
                </span>
                <span className={hasRequiredLab ? 'text-green-400' : 'text-slate-500'}>
                  {labName} {hasRequiredLab ? '' : ''}
                </span>
              </div>
            )}
          </div>
          <div className="flex gap-2">
            <button
              onClick={onDiscard}
              className="px-3 py-1.5 text-sm text-slate-400 hover:text-white"
            >
              Discard
            </button>
            <button
              onClick={onApply}
              className="flex items-center gap-1.5 px-4 py-1.5 bg-green-600 hover:bg-green-500 text-white text-sm rounded-lg"
            >
              <CheckCircle className="w-4 h-4" />
              Apply Draft
            </button>
          </div>
        </div>
      </div>

      {/* AI Reasoning */}
      {reasoning && (
        <div className="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
          <h3 className="text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
            <Sparkles className="w-4 h-4" />
            AI Reasoning
          </h3>
          <p className="text-slate-300 text-sm">{reasoning}</p>
        </div>
      )}

      {/* Title & Summary */}
      <section className="bg-slate-800/30 rounded-lg p-4 border border-slate-700">
        <h3 className="text-lg font-medium text-white mb-3">{draft.title}</h3>
        <p className="text-slate-300">{draft.summary}</p>
      </section>

      {/* Objective Framing & Current State */}
      <div className="grid grid-cols-2 gap-4">
        <div className="bg-slate-800/30 rounded-lg p-4 border border-slate-700">
          <h4 className="text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
            <Target className="w-4 h-4" />
            Objective Framing
          </h4>
          <p className="text-slate-300 text-sm">{draft.objectiveFraming}</p>
        </div>
        <div className="bg-slate-800/30 rounded-lg p-4 border border-slate-700">
          <h4 className="text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
            <Globe className="w-4 h-4" />
            Current State
          </h4>
          <p className="text-slate-300 text-sm">{draft.currentStateSummary}</p>
        </div>
      </div>

      {/* Priorities */}
      <section className="bg-slate-800/30 rounded-lg p-4 border border-slate-700">
        <h4 className="text-sm font-medium text-slate-400 mb-3 flex items-center gap-2">
          <Target className="w-4 h-4 text-amber-400" />
          Priorities ({draft.priorities.length})
        </h4>
        <div className="space-y-2">
          {draft.priorities.map((priority, idx) => (
            <div key={idx} className="flex items-start gap-3 bg-slate-900/50 p-3 rounded">
              <span className="text-amber-400 font-medium">{idx + 1}.</span>
              <div>
                <div className="text-white font-medium">{priority.label}</div>
                {priority.rationale && (
                  <div className="text-slate-400 text-sm">{priority.rationale}</div>
                )}
              </div>
            </div>
          ))}
        </div>
      </section>

      {/* Sequencing */}
      <section className="bg-slate-800/30 rounded-lg p-4 border border-slate-700">
        <h4 className="text-sm font-medium text-slate-400 mb-3 flex items-center gap-2">
          <Layers className="w-4 h-4 text-purple-400" />
          Sequencing ({draft.sequencing.length} phases)
        </h4>
        <div className="space-y-3">
          {draft.sequencing.map((phase, idx) => (
            <div key={idx} className="bg-slate-900/50 p-3 rounded">
              <div className="text-white font-medium mb-2">{phase.phase}</div>
              <ul className="space-y-1">
                {phase.items.map((item, itemIdx) => (
                  <li key={itemIdx} className="text-slate-400 text-sm flex items-start gap-2">
                    <span className="text-purple-400"></span>
                    {item}
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>
      </section>

      {/* Exclusions */}
      {draft.exclusions.length > 0 && (
        <section className="bg-slate-800/30 rounded-lg p-4 border border-slate-700">
          <h4 className="text-sm font-medium text-slate-400 mb-3 flex items-center gap-2">
            <Ban className="w-4 h-4 text-red-400" />
            Exclusions (Out of Scope)
          </h4>
          <div className="space-y-2">
            {draft.exclusions.map((exclusion, idx) => (
              <div key={idx} className="flex items-start gap-3 bg-slate-900/50 p-3 rounded">
                <Ban className="w-4 h-4 text-red-400 mt-0.5" />
                <div>
                  <div className="text-white">{exclusion.item}</div>
                  <div className="text-slate-400 text-sm">{exclusion.reason}</div>
                </div>
              </div>
            ))}
          </div>
        </section>
      )}

      {/* Readiness Gates */}
      <section className="bg-slate-800/30 rounded-lg p-4 border border-slate-700">
        <h4 className="text-sm font-medium text-slate-400 mb-3 flex items-center gap-2">
          <ListChecks className="w-4 h-4 text-green-400" />
          Readiness Gates ({draft.readinessGates.length})
        </h4>
        <div className="space-y-3">
          {draft.readinessGates.map((gate, idx) => (
            <div key={idx} className="bg-slate-900/50 p-3 rounded">
              <div className="text-white font-medium mb-2 flex items-center gap-2">
                <CheckCircle className="w-4 h-4 text-green-400" />
                {gate.gate}
              </div>
              <ul className="space-y-1 ml-6">
                {gate.criteria.map((criterion, criterionIdx) => (
                  <li key={criterionIdx} className="text-slate-400 text-sm flex items-start gap-2">
                    <span className="text-green-500"></span>
                    {criterion}
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>
      </section>

      {/* AI Transparency */}
      <div className="grid grid-cols-3 gap-4">
        {draft.assumptions.length > 0 && (
          <div className="bg-amber-900/20 rounded-lg p-4 border border-amber-700/30">
            <h4 className="text-sm font-medium text-amber-400 mb-2 flex items-center gap-2">
              <AlertTriangle className="w-4 h-4" />
              Assumptions
            </h4>
            <ul className="space-y-1">
              {draft.assumptions.map((item, idx) => (
                <li key={idx} className="text-amber-200/80 text-sm"> {item}</li>
              ))}
            </ul>
          </div>
        )}

        {draft.unknowns.length > 0 && (
          <div className="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
            <h4 className="text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
              <HelpCircle className="w-4 h-4" />
              Unknowns
            </h4>
            <ul className="space-y-1">
              {draft.unknowns.map((item, idx) => (
                <li key={idx} className="text-slate-300 text-sm"> {item}</li>
              ))}
            </ul>
          </div>
        )}

        {draft.dependencies.length > 0 && (
          <div className="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
            <h4 className="text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
              <LinkIcon className="w-4 h-4" />
              Dependencies
            </h4>
            <ul className="space-y-1">
              {draft.dependencies.map((item, idx) => (
                <li key={idx} className="text-slate-300 text-sm"> {item}</li>
              ))}
            </ul>
          </div>
        )}
      </div>
    </div>
  );
}

function ProgramEditor({
  plan,
  onUpdatePlan,
  status,
}: {
  plan: WebsiteProgramPlan;
  onUpdatePlan: <K extends keyof WebsiteProgramPlan>(
    field: K,
    value: WebsiteProgramPlan[K]
  ) => void;
  status: string;
}) {
  return (
    <div className="space-y-8 max-w-4xl">
      {/* Title & Summary */}
      <section>
        <h3 className="text-lg font-medium text-white mb-4 flex items-center gap-2">
          <FileText className="w-5 h-5 text-blue-400" />
          Program Overview
        </h3>
        <div className="space-y-4">
          <div>
            <label className="block text-sm text-slate-400 mb-1">Title</label>
            <input
              type="text"
              value={plan.title}
              onChange={e => onUpdatePlan('title', e.target.value)}
              className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500"
            />
          </div>
          <div>
            <label className="block text-sm text-slate-400 mb-1">Summary</label>
            <textarea
              value={plan.summary}
              onChange={e => onUpdatePlan('summary', e.target.value)}
              rows={3}
              className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500 resize-none"
            />
          </div>
        </div>
      </section>

      {/* Objective Framing & Current State */}
      {(plan.objectiveFraming || plan.currentStateSummary) && (
        <section className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm text-slate-400 mb-1">Objective Framing</label>
            <textarea
              value={plan.objectiveFraming || ''}
              onChange={e => onUpdatePlan('objectiveFraming', e.target.value)}
              rows={3}
              className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500 resize-none"
            />
          </div>
          <div>
            <label className="block text-sm text-slate-400 mb-1">Current State Summary</label>
            <textarea
              value={plan.currentStateSummary || ''}
              onChange={e => onUpdatePlan('currentStateSummary', e.target.value)}
              rows={3}
              className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500 resize-none"
            />
          </div>
        </section>
      )}

      {/* Priorities */}
      <section>
        <h3 className="text-lg font-medium text-white mb-4 flex items-center gap-2">
          <Target className="w-5 h-5 text-amber-400" />
          Priorities
        </h3>
        <PriorityEditor
          priorities={plan.priorities}
          onChange={priorities => onUpdatePlan('priorities', priorities)}
        />
      </section>

      {/* Sequencing */}
      <section>
        <h3 className="text-lg font-medium text-white mb-4 flex items-center gap-2">
          <Layers className="w-5 h-5 text-purple-400" />
          Sequencing
        </h3>
        <SequencingEditor
          phases={plan.sequencing}
          onChange={phases => onUpdatePlan('sequencing', phases)}
        />
      </section>

      {/* Exclusions */}
      {plan.exclusions && plan.exclusions.length > 0 && (
        <section>
          <h3 className="text-lg font-medium text-white mb-4 flex items-center gap-2">
            <Ban className="w-5 h-5 text-red-400" />
            Exclusions (Out of Scope)
          </h3>
          <ExclusionsEditor
            exclusions={plan.exclusions}
            onChange={exclusions => onUpdatePlan('exclusions', exclusions)}
          />
        </section>
      )}

      {/* Readiness Gates */}
      <section>
        <h3 className="text-lg font-medium text-white mb-4 flex items-center gap-2">
          <ListChecks className="w-5 h-5 text-green-400" />
          Readiness Gates
        </h3>
        <ReadinessGatesEditor
          gates={plan.readinessGates}
          onChange={gates => onUpdatePlan('readinessGates', gates)}
        />
      </section>

      {/* AI Transparency (read-only display) */}
      {(plan.assumptions?.length || plan.unknowns?.length || plan.dependencies?.length) && (
        <section className="border-t border-slate-800 pt-6">
          <h3 className="text-sm font-medium text-slate-500 mb-4">AI Analysis Notes</h3>
          <div className="grid grid-cols-3 gap-4">
            {plan.assumptions && plan.assumptions.length > 0 && (
              <div className="bg-amber-900/20 rounded-lg p-3 border border-amber-700/30">
                <h4 className="text-xs font-medium text-amber-400 mb-2">Assumptions</h4>
                <ul className="space-y-1">
                  {plan.assumptions.map((item, idx) => (
                    <li key={idx} className="text-amber-200/70 text-xs"> {item}</li>
                  ))}
                </ul>
              </div>
            )}

            {plan.unknowns && plan.unknowns.length > 0 && (
              <div className="bg-slate-800/50 rounded-lg p-3 border border-slate-700">
                <h4 className="text-xs font-medium text-slate-400 mb-2">Unknowns</h4>
                <ul className="space-y-1">
                  {plan.unknowns.map((item, idx) => (
                    <li key={idx} className="text-slate-400 text-xs"> {item}</li>
                  ))}
                </ul>
              </div>
            )}

            {plan.dependencies && plan.dependencies.length > 0 && (
              <div className="bg-slate-800/50 rounded-lg p-3 border border-slate-700">
                <h4 className="text-xs font-medium text-slate-400 mb-2">Dependencies</h4>
                <ul className="space-y-1">
                  {plan.dependencies.map((item, idx) => (
                    <li key={idx} className="text-slate-400 text-xs"> {item}</li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        </section>
      )}
    </div>
  );
}

// ============================================================================
// Priority Editor
// ============================================================================

function PriorityEditor({
  priorities,
  onChange,
}: {
  priorities: ProgramPriority[];
  onChange: (priorities: ProgramPriority[]) => void;
}) {
  const addPriority = () => {
    onChange([...priorities, { label: '', rationale: '' }]);
  };

  const updatePriority = (index: number, field: keyof ProgramPriority, value: string) => {
    const updated = [...priorities];
    updated[index] = { ...updated[index], [field]: value };
    onChange(updated);
  };

  const removePriority = (index: number) => {
    onChange(priorities.filter((_, i) => i !== index));
  };

  return (
    <div className="space-y-3">
      {priorities.map((priority, index) => (
        <div
          key={index}
          className="flex items-start gap-3 bg-slate-800/50 p-3 rounded-lg border border-slate-700"
        >
          <span className="text-slate-500 font-medium mt-2">{index + 1}.</span>
          <div className="flex-1 space-y-2">
            <input
              type="text"
              value={priority.label}
              onChange={e => updatePriority(index, 'label', e.target.value)}
              placeholder="Priority label"
              className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded text-white focus:outline-none focus:border-blue-500"
            />
            <input
              type="text"
              value={priority.rationale || ''}
              onChange={e => updatePriority(index, 'rationale', e.target.value)}
              placeholder="Rationale (optional)"
              className="w-full px-3 py-1.5 bg-slate-900 border border-slate-700 rounded text-slate-300 text-sm focus:outline-none focus:border-blue-500"
            />
          </div>
          <button
            onClick={() => removePriority(index)}
            className="p-2 text-slate-500 hover:text-red-400"
          >
            <Trash2 className="w-4 h-4" />
          </button>
        </div>
      ))}
      <button
        onClick={addPriority}
        className="flex items-center gap-2 px-3 py-2 text-sm text-slate-400 hover:text-white border border-dashed border-slate-700 rounded-lg hover:border-slate-500"
      >
        <Plus className="w-4 h-4" />
        Add Priority
      </button>
    </div>
  );
}

// ============================================================================
// Sequencing Editor
// ============================================================================

function SequencingEditor({
  phases,
  onChange,
}: {
  phases: ProgramPhase[];
  onChange: (phases: ProgramPhase[]) => void;
}) {
  const [expandedPhases, setExpandedPhases] = useState<Set<number>>(
    new Set(phases.map((_, i) => i))
  );

  const togglePhase = (index: number) => {
    const next = new Set(expandedPhases);
    if (next.has(index)) {
      next.delete(index);
    } else {
      next.add(index);
    }
    setExpandedPhases(next);
  };

  const addPhase = () => {
    onChange([...phases, { phase: `Phase ${phases.length + 1}`, items: [] }]);
    setExpandedPhases(prev => new Set([...prev, phases.length]));
  };

  const updatePhaseName = (index: number, name: string) => {
    const updated = [...phases];
    updated[index] = { ...updated[index], phase: name };
    onChange(updated);
  };

  const addItem = (phaseIndex: number) => {
    const updated = [...phases];
    updated[phaseIndex] = {
      ...updated[phaseIndex],
      items: [...updated[phaseIndex].items, ''],
    };
    onChange(updated);
  };

  const updateItem = (phaseIndex: number, itemIndex: number, value: string) => {
    const updated = [...phases];
    const items = [...updated[phaseIndex].items];
    items[itemIndex] = value;
    updated[phaseIndex] = { ...updated[phaseIndex], items };
    onChange(updated);
  };

  const removeItem = (phaseIndex: number, itemIndex: number) => {
    const updated = [...phases];
    updated[phaseIndex] = {
      ...updated[phaseIndex],
      items: updated[phaseIndex].items.filter((_, i) => i !== itemIndex),
    };
    onChange(updated);
  };

  const removePhase = (index: number) => {
    onChange(phases.filter((_, i) => i !== index));
  };

  return (
    <div className="space-y-3">
      {phases.map((phase, phaseIndex) => (
        <div
          key={phaseIndex}
          className="bg-slate-800/50 rounded-lg border border-slate-700 overflow-hidden"
        >
          <div
            className="flex items-center gap-2 px-3 py-2 cursor-pointer hover:bg-slate-800"
            onClick={() => togglePhase(phaseIndex)}
          >
            {expandedPhases.has(phaseIndex) ? (
              <ChevronDown className="w-4 h-4 text-slate-500" />
            ) : (
              <ChevronRight className="w-4 h-4 text-slate-500" />
            )}
            <input
              type="text"
              value={phase.phase}
              onChange={e => {
                e.stopPropagation();
                updatePhaseName(phaseIndex, e.target.value);
              }}
              onClick={e => e.stopPropagation()}
              className="flex-1 bg-transparent text-white font-medium focus:outline-none"
            />
            <span className="text-sm text-slate-500">{phase.items.length} items</span>
            <button
              onClick={e => {
                e.stopPropagation();
                removePhase(phaseIndex);
              }}
              className="p-1 text-slate-500 hover:text-red-400"
            >
              <Trash2 className="w-4 h-4" />
            </button>
          </div>

          {expandedPhases.has(phaseIndex) && (
            <div className="px-3 pb-3 space-y-2">
              {phase.items.map((item, itemIndex) => (
                <div key={itemIndex} className="flex items-center gap-2 pl-6">
                  <span className="text-slate-600"></span>
                  <input
                    type="text"
                    value={item}
                    onChange={e => updateItem(phaseIndex, itemIndex, e.target.value)}
                    placeholder="Action item"
                    className="flex-1 px-2 py-1 bg-slate-900 border border-slate-700 rounded text-sm text-slate-300 focus:outline-none focus:border-blue-500"
                  />
                  <button
                    onClick={() => removeItem(phaseIndex, itemIndex)}
                    className="p-1 text-slate-500 hover:text-red-400"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                </div>
              ))}
              <button
                onClick={() => addItem(phaseIndex)}
                className="flex items-center gap-1 pl-6 text-sm text-slate-500 hover:text-slate-300"
              >
                <Plus className="w-3 h-3" />
                Add item
              </button>
            </div>
          )}
        </div>
      ))}
      <button
        onClick={addPhase}
        className="flex items-center gap-2 px-3 py-2 text-sm text-slate-400 hover:text-white border border-dashed border-slate-700 rounded-lg hover:border-slate-500"
      >
        <Plus className="w-4 h-4" />
        Add Phase
      </button>
    </div>
  );
}

// ============================================================================
// Exclusions Editor
// ============================================================================

function ExclusionsEditor({
  exclusions,
  onChange,
}: {
  exclusions: ProgramExclusion[];
  onChange: (exclusions: ProgramExclusion[]) => void;
}) {
  const addExclusion = () => {
    onChange([...exclusions, { item: '', reason: '' }]);
  };

  const updateExclusion = (index: number, field: keyof ProgramExclusion, value: string) => {
    const updated = [...exclusions];
    updated[index] = { ...updated[index], [field]: value };
    onChange(updated);
  };

  const removeExclusion = (index: number) => {
    onChange(exclusions.filter((_, i) => i !== index));
  };

  return (
    <div className="space-y-3">
      {exclusions.map((exclusion, index) => (
        <div
          key={index}
          className="flex items-start gap-3 bg-slate-800/50 p-3 rounded-lg border border-slate-700"
        >
          <Ban className="w-4 h-4 text-red-400 mt-2" />
          <div className="flex-1 space-y-2">
            <input
              type="text"
              value={exclusion.item}
              onChange={e => updateExclusion(index, 'item', e.target.value)}
              placeholder="What's excluded"
              className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded text-white focus:outline-none focus:border-blue-500"
            />
            <input
              type="text"
              value={exclusion.reason}
              onChange={e => updateExclusion(index, 'reason', e.target.value)}
              placeholder="Why it's excluded"
              className="w-full px-3 py-1.5 bg-slate-900 border border-slate-700 rounded text-slate-300 text-sm focus:outline-none focus:border-blue-500"
            />
          </div>
          <button
            onClick={() => removeExclusion(index)}
            className="p-2 text-slate-500 hover:text-red-400"
          >
            <Trash2 className="w-4 h-4" />
          </button>
        </div>
      ))}
      <button
        onClick={addExclusion}
        className="flex items-center gap-2 px-3 py-2 text-sm text-slate-400 hover:text-white border border-dashed border-slate-700 rounded-lg hover:border-slate-500"
      >
        <Plus className="w-4 h-4" />
        Add Exclusion
      </button>
    </div>
  );
}

// ============================================================================
// Readiness Gates Editor
// ============================================================================

function ReadinessGatesEditor({
  gates,
  onChange,
}: {
  gates: ProgramReadinessGate[];
  onChange: (gates: ProgramReadinessGate[]) => void;
}) {
  const [expandedGates, setExpandedGates] = useState<Set<number>>(
    new Set(gates.map((_, i) => i))
  );

  const toggleGate = (index: number) => {
    const next = new Set(expandedGates);
    if (next.has(index)) {
      next.delete(index);
    } else {
      next.add(index);
    }
    setExpandedGates(next);
  };

  const addGate = () => {
    onChange([...gates, { gate: '', criteria: [] }]);
    setExpandedGates(prev => new Set([...prev, gates.length]));
  };

  const updateGateName = (index: number, name: string) => {
    const updated = [...gates];
    updated[index] = { ...updated[index], gate: name };
    onChange(updated);
  };

  const addCriterion = (gateIndex: number) => {
    const updated = [...gates];
    updated[gateIndex] = {
      ...updated[gateIndex],
      criteria: [...updated[gateIndex].criteria, ''],
    };
    onChange(updated);
  };

  const updateCriterion = (gateIndex: number, criterionIndex: number, value: string) => {
    const updated = [...gates];
    const criteria = [...updated[gateIndex].criteria];
    criteria[criterionIndex] = value;
    updated[gateIndex] = { ...updated[gateIndex], criteria };
    onChange(updated);
  };

  const removeCriterion = (gateIndex: number, criterionIndex: number) => {
    const updated = [...gates];
    updated[gateIndex] = {
      ...updated[gateIndex],
      criteria: updated[gateIndex].criteria.filter((_, i) => i !== criterionIndex),
    };
    onChange(updated);
  };

  const removeGate = (index: number) => {
    onChange(gates.filter((_, i) => i !== index));
  };

  return (
    <div className="space-y-3">
      {gates.map((gate, gateIndex) => (
        <div
          key={gateIndex}
          className="bg-slate-800/50 rounded-lg border border-slate-700 overflow-hidden"
        >
          <div
            className="flex items-center gap-2 px-3 py-2 cursor-pointer hover:bg-slate-800"
            onClick={() => toggleGate(gateIndex)}
          >
            {expandedGates.has(gateIndex) ? (
              <ChevronDown className="w-4 h-4 text-slate-500" />
            ) : (
              <ChevronRight className="w-4 h-4 text-slate-500" />
            )}
            <CheckCircle className="w-4 h-4 text-green-500" />
            <input
              type="text"
              value={gate.gate}
              onChange={e => {
                e.stopPropagation();
                updateGateName(gateIndex, e.target.value);
              }}
              onClick={e => e.stopPropagation()}
              placeholder="Gate name"
              className="flex-1 bg-transparent text-white font-medium focus:outline-none"
            />
            <span className="text-sm text-slate-500">{gate.criteria.length} criteria</span>
            <button
              onClick={e => {
                e.stopPropagation();
                removeGate(gateIndex);
              }}
              className="p-1 text-slate-500 hover:text-red-400"
            >
              <Trash2 className="w-4 h-4" />
            </button>
          </div>

          {expandedGates.has(gateIndex) && (
            <div className="px-3 pb-3 space-y-2">
              {gate.criteria.map((criterion, criterionIndex) => (
                <div key={criterionIndex} className="flex items-center gap-2 pl-8">
                  <span className="text-green-600"></span>
                  <input
                    type="text"
                    value={criterion}
                    onChange={e =>
                      updateCriterion(gateIndex, criterionIndex, e.target.value)
                    }
                    placeholder="Criterion"
                    className="flex-1 px-2 py-1 bg-slate-900 border border-slate-700 rounded text-sm text-slate-300 focus:outline-none focus:border-blue-500"
                  />
                  <button
                    onClick={() => removeCriterion(gateIndex, criterionIndex)}
                    className="p-1 text-slate-500 hover:text-red-400"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                </div>
              ))}
              <button
                onClick={() => addCriterion(gateIndex)}
                className="flex items-center gap-1 pl-8 text-sm text-slate-500 hover:text-slate-300"
              >
                <Plus className="w-3 h-3" />
                Add criterion
              </button>
            </div>
          )}
        </div>
      ))}
      <button
        onClick={addGate}
        className="flex items-center gap-2 px-3 py-2 text-sm text-slate-400 hover:text-white border border-dashed border-slate-700 rounded-lg hover:border-slate-500"
      >
        <Plus className="w-4 h-4" />
        Add Readiness Gate
      </button>
    </div>
  );
}

// ============================================================================
// Refresh Diff View
// ============================================================================

function RefreshDiffView({
  previousPlan,
  draft,
  reasoning,
  inputsUsed,
  onApply,
  onDiscard,
  programType,
}: {
  previousPlan: ProgramPlan;
  draft: AIProgramDraft;
  reasoning: string;
  inputsUsed: GenerateProgramResponse['inputsUsed'] | null;
  onApply: () => void;
  onDiscard: () => void;
  programType: ProgramType;
}) {
  // State for assumptions acknowledgement
  const [assumptionsAcknowledged, setAssumptionsAcknowledged] = useState(false);

  // Compute lab-specific display
  const hasRequiredLab = programType === 'content' ? inputsUsed?.hasContentLab : inputsUsed?.hasWebsiteLab;
  const labName = programType === 'content' ? 'Content Lab' : 'Website Lab';

  // Compute diffs
  const prioritiesChanged = !arraysEqual(
    previousPlan.priorities.map(p => p.label),
    draft.priorities.map(p => p.label)
  );
  const sequencingChanged = !phasesEqual(previousPlan.sequencing, draft.sequencing);
  const exclusionsChanged = !arraysEqual(
    (previousPlan.exclusions || []).map(e => e.item),
    draft.exclusions.map(e => e.item)
  );
  const dependenciesChanged = !arraysEqual(
    previousPlan.dependencies || [],
    draft.dependencies
  );

  // Check if assumptions or unknowns changed
  const assumptionsChanged = !arraysEqual(
    previousPlan.assumptions || [],
    draft.assumptions
  );
  const unknownsChanged = !arraysEqual(
    previousPlan.unknowns || [],
    draft.unknowns
  );
  const hasAssumptionChanges = assumptionsChanged || unknownsChanged;

  // Require acknowledgement if assumptions changed
  const canApply = !hasAssumptionChanges || assumptionsAcknowledged;

  const changeCount = [prioritiesChanged, sequencingChanged, exclusionsChanged, dependenciesChanged, assumptionsChanged, unknownsChanged].filter(Boolean).length;

  return (
    <div className="space-y-6">
      {/* Diff Header */}
      <div className="bg-purple-900/30 border border-purple-700/50 rounded-lg p-4">
        <div className="flex items-start gap-3">
          <RefreshCw className="w-5 h-5 text-purple-400 mt-0.5" />
          <div className="flex-1">
            <h2 className="text-lg font-medium text-purple-200 mb-1">
              Refresh Changes Review
            </h2>
            <p className="text-purple-300/80 text-sm mb-3">
              AI has updated your program. Review the changes below before applying.
              {changeCount > 0 && (
                <span className="ml-2 px-2 py-0.5 bg-purple-500/30 rounded text-purple-200">
                  {changeCount} section{changeCount !== 1 ? 's' : ''} changed
                </span>
              )}
            </p>
            {inputsUsed && (
              <div className="flex items-center gap-4 text-xs text-purple-400/70">
                <span>Inputs used:</span>
                <span className={inputsUsed.hasContext ? 'text-green-400' : 'text-slate-500'}>
                  Context {inputsUsed.hasContext ? '' : ''}
                </span>
                <span className={inputsUsed.hasStrategy ? 'text-green-400' : 'text-slate-500'}>
                  Strategy {inputsUsed.hasStrategy ? '' : ''}
                </span>
                <span className={hasRequiredLab ? 'text-green-400' : 'text-slate-500'}>
                  {labName} {hasRequiredLab ? '' : ''}
                </span>
              </div>
            )}
          </div>
          <div className="flex gap-2">
            <button
              onClick={onDiscard}
              className="px-3 py-1.5 text-sm text-slate-400 hover:text-white"
            >
              Discard
            </button>
            <button
              onClick={onApply}
              disabled={!canApply}
              className="flex items-center gap-1.5 px-4 py-1.5 bg-green-600 hover:bg-green-500 text-white text-sm rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <CheckCircle className="w-4 h-4" />
              Apply Changes
            </button>
          </div>
        </div>
      </div>

      {/* AI Reasoning */}
      {reasoning && (
        <div className="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
          <h3 className="text-sm font-medium text-slate-400 mb-2 flex items-center gap-2">
            <Sparkles className="w-4 h-4" />
            Why these changes?
          </h3>
          <p className="text-slate-300 text-sm">{reasoning}</p>
        </div>
      )}

      {/* Priorities Diff */}
      <DiffSection
        title="Priorities"
        icon={<Target className="w-4 h-4 text-amber-400" />}
        changed={prioritiesChanged}
      >
        <div className="grid grid-cols-2 gap-4">
          <DiffColumn label="Previous" type="old">
            {previousPlan.priorities.map((p, idx) => (
              <DiffItem
                key={idx}
                label={`${idx + 1}. ${p.label}`}
                detail={p.rationale}
                status={draft.priorities.some(np => np.label === p.label) ? 'unchanged' : 'removed'}
              />
            ))}
          </DiffColumn>
          <DiffColumn label="Proposed" type="new">
            {draft.priorities.map((p, idx) => (
              <DiffItem
                key={idx}
                label={`${idx + 1}. ${p.label}`}
                detail={p.rationale}
                status={previousPlan.priorities.some(op => op.label === p.label) ? 'unchanged' : 'added'}
              />
            ))}
          </DiffColumn>
        </div>
      </DiffSection>

      {/* Sequencing Diff */}
      <DiffSection
        title="Sequencing"
        icon={<Layers className="w-4 h-4 text-purple-400" />}
        changed={sequencingChanged}
      >
        <div className="grid grid-cols-2 gap-4">
          <DiffColumn label="Previous" type="old">
            {previousPlan.sequencing.map((phase, idx) => (
              <DiffPhase
                key={idx}
                phase={phase}
                comparePhases={draft.sequencing}
              />
            ))}
          </DiffColumn>
          <DiffColumn label="Proposed" type="new">
            {draft.sequencing.map((phase, idx) => (
              <DiffPhase
                key={idx}
                phase={phase}
                comparePhases={previousPlan.sequencing}
                isNew
              />
            ))}
          </DiffColumn>
        </div>
      </DiffSection>

      {/* Exclusions Diff */}
      <DiffSection
        title="Exclusions (Out of Scope)"
        icon={<Ban className="w-4 h-4 text-red-400" />}
        changed={exclusionsChanged}
      >
        <div className="grid grid-cols-2 gap-4">
          <DiffColumn label="Previous" type="old">
            {(previousPlan.exclusions || []).length === 0 ? (
              <p className="text-slate-500 text-sm italic">No exclusions defined</p>
            ) : (
              (previousPlan.exclusions || []).map((e, idx) => (
                <DiffItem
                  key={idx}
                  label={e.item}
                  detail={e.reason}
                  status={draft.exclusions.some(ne => ne.item === e.item) ? 'unchanged' : 'removed'}
                />
              ))
            )}
          </DiffColumn>
          <DiffColumn label="Proposed" type="new">
            {draft.exclusions.length === 0 ? (
              <p className="text-slate-500 text-sm italic">No exclusions defined</p>
            ) : (
              draft.exclusions.map((e, idx) => (
                <DiffItem
                  key={idx}
                  label={e.item}
                  detail={e.reason}
                  status={(previousPlan.exclusions || []).some(oe => oe.item === e.item) ? 'unchanged' : 'added'}
                />
              ))
            )}
          </DiffColumn>
        </div>
      </DiffSection>

      {/* Dependencies Diff */}
      <DiffSection
        title="Dependencies"
        icon={<LinkIcon className="w-4 h-4 text-blue-400" />}
        changed={dependenciesChanged}
      >
        <div className="grid grid-cols-2 gap-4">
          <DiffColumn label="Previous" type="old">
            {(previousPlan.dependencies || []).length === 0 ? (
              <p className="text-slate-500 text-sm italic">No dependencies defined</p>
            ) : (
              (previousPlan.dependencies || []).map((d, idx) => (
                <DiffItem
                  key={idx}
                  label={d}
                  status={draft.dependencies.includes(d) ? 'unchanged' : 'removed'}
                />
              ))
            )}
          </DiffColumn>
          <DiffColumn label="Proposed" type="new">
            {draft.dependencies.length === 0 ? (
              <p className="text-slate-500 text-sm italic">No dependencies defined</p>
            ) : (
              draft.dependencies.map((d, idx) => (
                <DiffItem
                  key={idx}
                  label={d}
                  status={(previousPlan.dependencies || []).includes(d) ? 'unchanged' : 'added'}
                />
              ))
            )}
          </DiffColumn>
        </div>
      </DiffSection>

      {/* Assumptions & Unknowns Diff (with acknowledgement) */}
      {hasAssumptionChanges && (
        <DiffSection
          title="Assumptions & Unknowns"
          icon={<AlertTriangle className="w-4 h-4 text-amber-400" />}
          changed={true}
        >
          <div className="space-y-4">
            {/* Warning banner */}
            <div className="bg-amber-900/30 border border-amber-700/50 rounded-lg p-3">
              <div className="flex items-start gap-2">
                <AlertTriangle className="w-4 h-4 text-amber-400 mt-0.5 flex-shrink-0" />
                <p className="text-amber-200 text-sm">
                  The AI has changed the assumptions or unknowns for this program.
                  Please review carefully as this may affect scope.
                </p>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              {/* Assumptions */}
              {assumptionsChanged && (
                <>
                  <DiffColumn label="Previous Assumptions" type="old">
                    {(previousPlan.assumptions || []).length === 0 ? (
                      <p className="text-slate-500 text-sm italic">No assumptions</p>
                    ) : (
                      (previousPlan.assumptions || []).map((a, idx) => (
                        <DiffItem
                          key={idx}
                          label={a}
                          status={draft.assumptions.includes(a) ? 'unchanged' : 'removed'}
                        />
                      ))
                    )}
                  </DiffColumn>
                  <DiffColumn label="Proposed Assumptions" type="new">
                    {draft.assumptions.length === 0 ? (
                      <p className="text-slate-500 text-sm italic">No assumptions</p>
                    ) : (
                      draft.assumptions.map((a, idx) => (
                        <DiffItem
                          key={idx}
                          label={a}
                          status={(previousPlan.assumptions || []).includes(a) ? 'unchanged' : 'added'}
                        />
                      ))
                    )}
                  </DiffColumn>
                </>
              )}

              {/* Unknowns */}
              {unknownsChanged && (
                <>
                  <DiffColumn label="Previous Unknowns" type="old">
                    {(previousPlan.unknowns || []).length === 0 ? (
                      <p className="text-slate-500 text-sm italic">No unknowns</p>
                    ) : (
                      (previousPlan.unknowns || []).map((u, idx) => (
                        <DiffItem
                          key={idx}
                          label={u}
                          status={draft.unknowns.includes(u) ? 'unchanged' : 'removed'}
                        />
                      ))
                    )}
                  </DiffColumn>
                  <DiffColumn label="Proposed Unknowns" type="new">
                    {draft.unknowns.length === 0 ? (
                      <p className="text-slate-500 text-sm italic">No unknowns</p>
                    ) : (
                      draft.unknowns.map((u, idx) => (
                        <DiffItem
                          key={idx}
                          label={u}
                          status={(previousPlan.unknowns || []).includes(u) ? 'unchanged' : 'added'}
                        />
                      ))
                    )}
                  </DiffColumn>
                </>
              )}
            </div>

            {/* Acknowledgement checkbox */}
            <div className="bg-slate-800/50 rounded-lg p-4 border border-amber-600/50">
              <label className="flex items-start gap-3 cursor-pointer">
                <input
                  type="checkbox"
                  checked={assumptionsAcknowledged}
                  onChange={(e) => setAssumptionsAcknowledged(e.target.checked)}
                  className="mt-0.5 w-4 h-4 rounded border-amber-600 text-amber-500 focus:ring-amber-500 focus:ring-offset-slate-900"
                />
                <span className="text-sm text-slate-200">
                  I acknowledge that the assumptions have changed and understand this may affect the program scope.
                </span>
              </label>
            </div>
          </div>
        </DiffSection>
      )}

      {/* Action Footer */}
      <div className="flex justify-end gap-3 pt-4 border-t border-slate-800">
        <button
          onClick={onDiscard}
          className="px-4 py-2 text-slate-400 hover:text-white"
        >
          Discard Changes
        </button>
        <button
          onClick={onApply}
          disabled={!canApply}
          title={!canApply ? 'Acknowledge assumption changes to apply' : undefined}
          className="flex items-center gap-2 px-6 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <CheckCircle className="w-4 h-4" />
          Apply Changes
        </button>
      </div>
    </div>
  );
}

// ============================================================================
// Diff Helper Components
// ============================================================================

function DiffSection({
  title,
  icon,
  changed,
  children,
}: {
  title: string;
  icon: React.ReactNode;
  changed: boolean;
  children: React.ReactNode;
}) {
  return (
    <section className="bg-slate-800/30 rounded-lg border border-slate-700 overflow-hidden">
      <div className="px-4 py-3 bg-slate-800/50 border-b border-slate-700 flex items-center justify-between">
        <h3 className="text-sm font-medium text-slate-200 flex items-center gap-2">
          {icon}
          {title}
        </h3>
        {changed ? (
          <span className="text-xs px-2 py-0.5 bg-amber-500/20 text-amber-400 rounded">
            Changed
          </span>
        ) : (
          <span className="text-xs px-2 py-0.5 bg-slate-700/50 text-slate-500 rounded">
            Unchanged
          </span>
        )}
      </div>
      <div className="p-4">{children}</div>
    </section>
  );
}

function DiffColumn({
  label,
  type,
  children,
}: {
  label: string;
  type: 'old' | 'new';
  children: React.ReactNode;
}) {
  return (
    <div>
      <div
        className={`text-xs font-medium mb-2 ${
          type === 'old' ? 'text-red-400/70' : 'text-green-400/70'
        }`}
      >
        {label}
      </div>
      <div className="space-y-2">{children}</div>
    </div>
  );
}

function DiffItem({
  label,
  detail,
  status,
}: {
  label: string;
  detail?: string;
  status: 'added' | 'removed' | 'unchanged';
}) {
  const bgColor =
    status === 'added'
      ? 'bg-green-900/30 border-green-700/50'
      : status === 'removed'
      ? 'bg-red-900/30 border-red-700/50'
      : 'bg-slate-900/50 border-slate-700';

  const textColor =
    status === 'added'
      ? 'text-green-200'
      : status === 'removed'
      ? 'text-red-200 line-through'
      : 'text-slate-300';

  return (
    <div className={`p-2 rounded border ${bgColor}`}>
      <div className={`text-sm ${textColor}`}>{label}</div>
      {detail && <div className="text-xs text-slate-500 mt-1">{detail}</div>}
    </div>
  );
}

function DiffPhase({
  phase,
  comparePhases,
  isNew,
}: {
  phase: ProgramPhase;
  comparePhases: ProgramPhase[];
  isNew?: boolean;
}) {
  const matchingPhase = comparePhases.find(p => p.phase === phase.phase);
  const phaseIsNew = !matchingPhase;

  return (
    <div
      className={`p-2 rounded border ${
        phaseIsNew
          ? isNew
            ? 'bg-green-900/30 border-green-700/50'
            : 'bg-red-900/30 border-red-700/50'
          : 'bg-slate-900/50 border-slate-700'
      }`}
    >
      <div
        className={`text-sm font-medium mb-1 ${
          phaseIsNew
            ? isNew
              ? 'text-green-200'
              : 'text-red-200 line-through'
            : 'text-slate-200'
        }`}
      >
        {phase.phase}
      </div>
      <ul className="space-y-1">
        {phase.items.map((item, idx) => {
          const itemInCompare = matchingPhase?.items.includes(item);
          const itemStatus = phaseIsNew
            ? isNew
              ? 'added'
              : 'removed'
            : itemInCompare
            ? 'unchanged'
            : isNew
            ? 'added'
            : 'removed';

          return (
            <li
              key={idx}
              className={`text-xs flex items-start gap-1.5 ${
                itemStatus === 'added'
                  ? 'text-green-300'
                  : itemStatus === 'removed'
                  ? 'text-red-300 line-through'
                  : 'text-slate-400'
              }`}
            >
              <span
                className={
                  itemStatus === 'added'
                    ? 'text-green-500'
                    : itemStatus === 'removed'
                    ? 'text-red-500'
                    : 'text-slate-600'
                }
              >
                
              </span>
              {item}
            </li>
          );
        })}
      </ul>
    </div>
  );
}

// ============================================================================
// Diff Utility Functions
// ============================================================================

function arraysEqual(a: string[], b: string[]): boolean {
  if (a.length !== b.length) return false;
  const sortedA = [...a].sort();
  const sortedB = [...b].sort();
  return sortedA.every((val, idx) => val === sortedB[idx]);
}

function phasesEqual(a: ProgramPhase[], b: ProgramPhase[]): boolean {
  if (a.length !== b.length) return false;
  return a.every((phase, idx) => {
    const bPhase = b[idx];
    if (phase.phase !== bPhase.phase) return false;
    return arraysEqual(phase.items, bPhase.items);
  });
}
